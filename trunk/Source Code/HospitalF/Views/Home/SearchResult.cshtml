@using HospitalF.Constant
@using HospitalF.Models;
@model List<HospitalF.Models.Hospital>

@{
    List<Hospital> hospitalList = (List<Hospital>)ViewBag.HospitalList;
    string suggestionSentence = (string)@ViewBag.SuggestionSentence;
}

<!-- MAIN CONTENT -->
<div id="content-results" class="col-md-10 col-md-offset-1 well">
    <legend>Nhập từ khóa về bệnh viện</legend>
    <div class="col-md-8">
        @using (Html.BeginForm(Constants.SearchResultAction, Constants.HomeController, FormMethod.Get, new { @class = "form-horizontal", @id = Constants.NormalSearchForm }))
        {

            <div class="input-group">
                @Html.TextBox("SearchValue", null, new { @class = "form-control", placeholder = "Nhập thông tin tìm kiếm..." })
                <div class="input-group-btn">
                    <button class="btn btn-default btn-primary" type="submit"
                            value="@Constants.NormalSearchForm" name="@Constants.Button"
                            id="normal-search-button">
                        <i class="fa fa-search"></i>&nbsp;Tìm Kiếm
                    </button>
                </div>
            </div>
            <p class="note"><strong>Ví dụ:</strong> chuyên khoa, tên bệnh viện, địa điểm...</p>
        }
    </div>
    <div class="col-md-12">
        @using (Html.BeginForm(Constants.FilterResultAction, Constants.HomeController, FormMethod.Get, new { @class = "form-horizontal" }))
        {
            <fieldset>
                @{
            if (!string.IsNullOrEmpty(suggestionSentence))
            {
                suggestionSentence = suggestionSentence.Trim();
                <p>
                    Có phải bạn muốn tìm <i>
                        @Html.ActionLink(suggestionSentence,
                                Constants.SearchResultAction, Constants.HomeController,
                                new { SearchValue = suggestionSentence }, null)
                    </i>
                </p>
            }

            if (hospitalList.Count == 0)
            {
                <p>Không có kết quả tìm kiếm với từ khóa <i><font color="blue">@ViewBag.SearchValue</font></i></p>
                    <input id="result-count" type="hidden" value="@hospitalList.Count" />
            }
                }

                <div class="row" id="filter-bar">
                    <div class="form-group col-md-4">
                        <label class="control-label col-md-4" for="prepend">Đánh Giá</label>
                        <div class="col-md-8">
                            <div class="icon-addon addon-sm">
                                <select class="form-control">
                                    <option>Cao Nhất</option>
                                    <option>Thấp Nhât</option>
                                </select>
                                <label class="glyphicon glyphicon-sort" title="Đánh Giá"></label>
                            </div>
                        </div>
                    </div>


                    <div class="form-group col-md-4">
                        <label class="control-label col-md-4" for="prepend">Loại</label>
                        <div class="col-md-8">
                            <div class="icon-addon addon-sm">
                                @Html.DropDownList("HospitalType", (SelectList)ViewBag.HospitalTypes, "Tất Cả", new { @class = "form-control" })
                                <label class="glyphicon glyphicon-list-alt" title="Loại Bệnh Viện"></label>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary pull-right" type="submit">
                            <i class="fa fa-refresh"></i>&nbsp;
                            Cập Nhật
                        </button>
                    </div>
                </div>
            </fieldset>
        }
    </div>

    <div class="col-md-12">
        <hr />
        <div id="hospital-list-results" class="col-md-4">
            <h1 class="font-md">Danh sách <span class="semi-bold">bệnh viện</span><small class="text-danger"> &nbsp;&nbsp;(@(hospitalList != null ? hospitalList.Count : 0) kết quả)</small></h1>
            @if (hospitalList != null)
            {
                foreach (Hospital hospital in hospitalList)
                {
                    <div class="search-results clearfix smart-form">

                        <h4><i class="fa fa-plus-square txt-color-blue"></i>&nbsp;<a href="javascript:void(0);">@(hospital.Hospital_Name)</a></h4>

                        <div>
                            <div class="rating display-inline">
                                <input type="radio" name="stars-rating" id="stars-rating-5">
                                <label for="stars-rating-5"><i class="fa fa-star"></i></label>
                                <input type="radio" name="stars-rating" id="stars-rating-4">
                                <label for="stars-rating-4"><i class="fa fa-star"></i></label>
                                <input type="radio" name="stars-rating" id="stars-rating-3">
                                <label for="stars-rating-3"><i class="fa fa-star"></i></label>
                                <input type="radio" name="stars-rating" id="stars-rating-2">
                                <label for="stars-rating-2"><i class="fa fa-star"></i></label>
                                <input type="radio" name="stars-rating" id="stars-rating-1">
                                <label for="stars-rating-1"><i class="fa fa-star"></i></label>
                            </div>
                            <br>
                            <div class="url text-success">
                                www.timkiembenhvien.com <i class="fa fa-caret-down"></i>
                            </div>
                            <p class="description">
                                Đây là cái bệnh viện.
                            </p>
                        </div>

                    </div>
                }
            }
            <div class="text-center">
                <hr>
                <ul class="pagination no-margin">
                    <li class="prev disabled">
                        <a href="javascript:void(0);">Previous</a>
                    </li>
                    <li class="active">
                        <a href="javascript:void(0);">1</a>
                    </li>
                    <li>
                        <a href="javascript:void(0);">2</a>
                    </li>
                    <li>
                        <a href="javascript:void(0);">3</a>
                    </li>
                    <li>
                        <a href="javascript:void(0);">4</a>
                    </li>
                    <li>
                        <a href="javascript:void(0);">5</a>
                    </li>
                    <li class="next">
                        <a href="javascript:void(0);">Next</a>
                    </li>
                </ul>
                <br>
                <br>
                <br>
            </div>
        </div>
        <div id="map-results" class="col-md-8">
            <div id="map-canvas"></div>
        </div>
    </div>
</div>
<!-- END MAIN CONTENT -->
<!-- GOOGLE API -->
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&language=vi"></script>

<script type="text/javascript">
    @*AJAX for auto completing basic search value textbox*@
    $(document).ready(function () {
        $("#SearchValue").on('input', function () {
            var statesProgress = $("#states-loading-search-progress");
            var availableTags = new Array();
            statesProgress.show();
            $.ajax({
                cache: false,
                type: "GET",
                url: "@(Url.RouteUrl(Constants.LoadSuggestSentenceAction))",
                success: function (data) {
                    $.each(data, function (id, option) {
                        availableTags.push(option);
                    });
                    statesProgress.hide();
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    statesProgress.hide();
                }
            });
            $("#SearchValue").autocomplete({
                source: function (request, response) {
                    var results = $.ui.autocomplete.filter(availableTags, request.term);
                    response(results.slice(0, 5));
                }
            });
        });
    });

    @*Display fitler bar*@
    $(document).ready(function () {
        var resultCount = $('#result-count').val();
        if (resultCount == 0) {
            $("#filter-bar").hide();
        }
        else {
            $("#filter-bar").show();
        }
    });

    @*Data validation*@
    $(document).ready(function () {
        $("#normal-search-button").click(function () {
            var searchValue = $('#SearchValue').val().trim();
            if (searchValue != "") {
                $('#normal-search-form').submit();
            }
            else {
                return false;
            }
        });
    });

    // Google Map API - Geolocation
    /*
    var map;

    function initialize() {
        var mapOptions = {
            zoom: 6
        };
        map = new google.maps.Map(document.getElementById('map-canvas'),
            mapOptions);

        // Try HTML5 geolocation
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                var pos = new google.maps.LatLng(position.coords.latitude,
                                                 position.coords.longitude);

                var infowindow = new google.maps.InfoWindow({
                    map: map,
                    position: pos,
                    content: 'Vị trí hiện tại của bạn.'
                });

                map.setCenter(pos);
            }, function () {
                handleNoGeolocation(true);
            });
        } else {
            // Browser doesn't support Geolocation
            handleNoGeolocation(false);
        }
    }

    function handleNoGeolocation(errorFlag) {
        if (errorFlag) {
            var content = 'Error: The Geolocation service failed.';
        } else {
            var content = 'Error: Your browser doesn\'t support geolocation.';
        }

        var options = {
            map: map,
            position: new google.maps.LatLng(60, 105),
            content: content
        };

        var infowindow = new google.maps.InfoWindow(options);
        map.setCenter(options.position);
    }

    google.maps.event.addDomListener(window, 'load', initialize);
    */
    // Set map
    var map;
    // List markers on map
    var markers = [];
    @if (hospitalList != null)
    {
        foreach (Hospital hospital in hospitalList)
        {
        <text>
    var hospital = [];
    hospital.push('@(Html.Raw(hospital.Hospital_Name))');
    var coordinate = '@(hospital.Coordinate)';
    var longitude = (coordinate.split(',')[0]).trim();
    var latitude = (coordinate.split(',')[1]).trim();
    hospital.push(longitude);
    hospital.push(latitude);
    markers.push(hospital);
    </text>
        }
    }
    function initializeMap() {
        var latlng = new google.maps.LatLng(markers[0][1], markers[0][2]);
        var options = {
            zoom: 15,
            center: latlng,
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            mapTypeControl: false
        };
        map = new google.maps.Map(document.getElementById("map-canvas"), options);
        var infowindow = new google.maps.InfoWindow(), marker, i;
        for (i = 0; i < markers.length; i++) {
            marker = new google.maps.Marker({
                position: new google.maps.LatLng(markers[i][1], markers[i][2]),
                map: map
            });
            google.maps.event.addListener(marker, 'click', (function (marker, i) {
                return function () {
                    infowindow.setContent(markers[i][0]);
                    infowindow.open(map, marker);
                }
            })(marker, i));
        }
    }


    google.maps.event.addDomListener(window, 'load', initializeMap);
</script>
